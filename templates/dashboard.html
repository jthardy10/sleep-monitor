<!DOCTYPE html>
<html>
<head>
   <title>Secure Sleep Monitor</title>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
   <style>
       body { font-family: Arial, sans-serif; margin: 20px; }
       .chart-container { 
           width: 80%; 
           margin: 20px auto; 
           padding: 20px;
           background-color: #f5f5f5;
           border-radius: 10px;
       }
       .metrics-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
           gap: 20px;
           margin: 20px;
       }
       .metric-card {
           background: white;
           padding: 20px;
           border-radius: 8px;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
           text-align: center;
       }
   </style>
</head>
<body>
   <h1>Secure Sleep Monitor</h1>
   <div class="metrics-grid" id="metricsGrid"></div>
   <div class="chart-container">
       <canvas id="sleepChart"></canvas>
   </div>
   
   <script>
       let socket;
       let chart;

       async function initializeConnection() {
           try {
               const response = await fetch('/api/token', {
                   method: 'POST'
               });
               const { token } = await response.json();
               
               socket = io('/', {
                   auth: { token },
                   secure: true,
                   rejectUnauthorized: false
               });

               socket.on('connect', () => {
                   console.log('Connected securely to server');
               });

               socket.on('data_update', updateDashboard);
               
               initializeChart();
           } catch (error) {
               console.error('Connection error:', error);
           }
       }

       function updateDashboard(data) {
           document.getElementById('metricsGrid').innerHTML = `
               <div class="metric-card">
                   <h3>Sleep Quality</h3>
                   <div>${(data.analysis.sleep_quality * 100).toFixed(1)}%</div>
               </div>
               <div class="metric-card">
                   <h3>Heart Rate</h3>
                   <div>${data.sensor_data.heart_rate} BPM</div>
               </div>
               <div class="metric-card">
                   <h3>Temperature</h3>
                   <div>${data.sensor_data.temperature}Â°C</div>
               </div>
           `;

           if (chart) {
               chart.data.labels.push(new Date(data.timestamp).toLocaleTimeString());
               chart.data.datasets[0].data.push(data.analysis.sleep_quality);
               
               if (chart.data.labels.length > 50) {
                   chart.data.labels.shift();
                   chart.data.datasets[0].data.shift();
               }
               
               chart.update();
           }
       }

       function initializeChart() {
           const ctx = document.getElementById('sleepChart').getContext('2d');
           chart = new Chart(ctx, {
               type: 'line',
               data: {
                   labels: [],
                   datasets: [{
                       label: 'Sleep Quality',
                       data: [],
                       borderColor: 'rgb(75, 192, 192)',
                       tension: 0.1
                   }]
               },
               options: {
                   responsive: true,
                   scales: {
                       y: {
                           beginAtZero: true,
                           max: 1
                       }
                   },
                   animation: {
                       duration: 0
                   }
               }
           });
       }

       initializeConnection();
   </script>
</body>
</html>
